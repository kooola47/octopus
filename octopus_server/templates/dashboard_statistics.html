<!-- Comprehensive Statistics Dashboard -->
<div class="octopus-card mb-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="octopus-section-title mb-0">
            <i class="bi bi-graph-up"></i>
            System Statistics Overview
        </h3>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshStatistics()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="exportStatistics()">
                <i class="bi bi-download"></i> Export
            </button>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 bg-gradient-primary text-white">
                <div class="card-body text-center">
                    <i class="bi bi-people display-6 mb-2"></i>
                    <h4 class="mb-1" id="totalClientsCount">0</h4>
                    <small>Total Clients</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-gradient-success text-white">
                <div class="card-body text-center">
                    <i class="bi bi-list-task display-6 mb-2"></i>
                    <h4 class="mb-1" id="totalTasksCount">0</h4>
                    <small>Total Tasks</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-gradient-info text-white">
                <div class="card-body text-center">
                    <i class="bi bi-play-circle display-6 mb-2"></i>
                    <h4 class="mb-1" id="totalExecutionsCount">0</h4>
                    <small>Total Executions</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-gradient-warning text-white">
                <div class="card-body text-center">
                    <i class="bi bi-speedometer2 display-6 mb-2"></i>
                    <h4 class="mb-1" id="systemHealthScore">0%</h4>
                    <small>System Health</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Statistics Tables -->
    <div class="row g-4">
        <!-- Client Statistics -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-people"></i> Client Statistics
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Metric</th>
                                    <th class="text-end">Value</th>
                                </tr>
                            </thead>
                            <tbody id="clientStatsTable">
                                <tr>
                                    <td><i class="bi bi-circle-fill text-success me-1"></i>Online Clients</td>
                                    <td class="text-end"><span id="onlineClientsCount">0</span></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-circle-fill text-danger me-1"></i>Offline Clients</td>
                                    <td class="text-end"><span id="offlineClientsCount">0</span></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-clock me-1"></i>Avg Response Time</td>
                                    <td class="text-end"><span id="avgResponseTime">0ms</span></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-cpu me-1"></i>Busy Clients</td>
                                    <td class="text-end"><span id="busyClientsCount">0</span></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-check-circle me-1"></i>Available Clients</td>
                                    <td class="text-end"><span id="availableClientsCount">0</span></td>
                                </tr>
                                <tr class="table-info">
                                    <td><strong><i class="bi bi-percent me-1"></i>Client Availability</strong></td>
                                    <td class="text-end"><strong><span id="clientAvailabilityRate">0%</span></strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Statistics -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-list-task"></i> Task Statistics
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Metric</th>
                                    <th class="text-end">Value</th>
                                </tr>
                            </thead>
                            <tbody id="taskStatsTable">
                                <tr>
                                    <td><i class="bi bi-play-circle text-primary me-1"></i>Active Tasks</td>
                                    <td class="text-end"><span id="activeTasksCount">0</span></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-check-circle text-success me-1"></i>Completed Tasks</td>
                                    <td class="text-end"><span id="completedTasksCount">0</span></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-x-circle text-danger me-1"></i>Failed Tasks</td>
                                    <td class="text-end"><span id="failedTasksCount">0</span></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-clock-history me-1"></i>Scheduled Tasks</td>
                                    <td class="text-end"><span id="scheduledTasksCount">0</span></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-lightning me-1"></i>Adhoc Tasks</td>
                                    <td class="text-end"><span id="adhocTasksCount">0</span></td>
                                </tr>
                                <tr class="table-success">
                                    <td><strong><i class="bi bi-percent me-1"></i>Success Rate</strong></td>
                                    <td class="text-end"><strong><span id="taskSuccessRate">0%</span></strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Execution Statistics -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-play-circle"></i> Execution Statistics
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Metric</th>
                                    <th class="text-end">Value</th>
                                </tr>
                            </thead>
                            <tbody id="executionStatsTable">
                                <tr>
                                    <td><i class="bi bi-check-circle text-success me-1"></i>Successful</td>
                                    <td class="text-end"><span id="successfulExecutionsCount">0</span></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-x-circle text-danger me-1"></i>Failed</td>
                                    <td class="text-end"><span id="failedExecutionsCount">0</span></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-exclamation-triangle text-warning me-1"></i>Errors</td>
                                    <td class="text-end"><span id="errorExecutionsCount">0</span></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-calendar-day me-1"></i>Today</td>
                                    <td class="text-end"><span id="todayExecutionsCount">0</span></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-calendar-week me-1"></i>This Week</td>
                                    <td class="text-end"><span id="weekExecutionsCount">0</span></td>
                                </tr>
                                <tr class="table-info">
                                    <td><strong><i class="bi bi-percent me-1"></i>Success Rate</strong></td>
                                    <td class="text-end"><strong><span id="executionSuccessRate">0%</span></strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Plugin Usage Statistics -->
    <div class="row g-4 mt-3">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-plugin"></i> Top Plugin Usage
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Plugin</th>
                                    <th class="text-center">Tasks</th>
                                    <th class="text-center">Executions</th>
                                    <th class="text-end">Success Rate</th>
                                </tr>
                            </thead>
                            <tbody id="pluginStatsTable">
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-3">
                                        <i class="bi bi-hourglass-split"></i> Loading plugin statistics...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Timeline -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="bi bi-clock-history"></i> Recent Activity (Last 24h)
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Time</th>
                                    <th>Event</th>
                                    <th class="text-end">Count</th>
                                </tr>
                            </thead>
                            <tbody id="activityTimelineTable">
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-3">
                                        <i class="bi bi-hourglass-split"></i> Loading recent activity...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Trends -->
    <div class="row g-4 mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-graph-up"></i> Performance Trends (Last 7 Days)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3 text-center">
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h5 class="text-primary mb-1" id="avgTasksPerDay">0</h5>
                                <small class="text-muted">Avg Tasks/Day</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h5 class="text-success mb-1" id="avgExecutionsPerDay">0</h5>
                                <small class="text-muted">Avg Executions/Day</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h5 class="text-info mb-1" id="avgResponseTime7d">0ms</h5>
                                <small class="text-muted">Avg Response Time</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h5 class="text-warning mb-1" id="systemUptime">0%</h5>
                                <small class="text-muted">System Uptime</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, var(--octopus-primary), var(--octopus-primary-dark));
}
.bg-gradient-success {
    background: linear-gradient(135deg, var(--octopus-success), #059669);
}
.bg-gradient-info {
    background: linear-gradient(135deg, var(--octopus-info), #2563eb);
}
.bg-gradient-warning {
    background: linear-gradient(135deg, var(--octopus-warning), #d97706);
}

.card {
    transition: transform 0.2s ease-in-out;
}
.card:hover {
    transform: translateY(-2px);
}

.table-sm td, .table-sm th {
    padding: 0.5rem 0.75rem;
}

.display-6 {
    font-size: 2.5rem;
}
</style>

<script>
// Statistics data storage
let statisticsData = {
    clients: [],
    tasks: {},
    executions: []
};

// Auto-refresh statistics every 30 seconds
let statisticsRefreshInterval;

function initializeStatistics() {
    refreshStatistics();
    
    // Set up auto-refresh
    statisticsRefreshInterval = setInterval(refreshStatistics, 30000);
    
    // Stop auto-refresh when user is inactive
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            clearInterval(statisticsRefreshInterval);
        } else {
            statisticsRefreshInterval = setInterval(refreshStatistics, 30000);
        }
    });
}

function refreshStatistics() {
    // Show loading state
    showStatisticsLoading();
    
    // Fetch all data in parallel
    Promise.all([
        fetch('/api/clients').then(r => r.json()),
        fetch('/api/tasks').then(r => r.json()),
        fetch('/api/executions').then(r => r.json())
    ]).then(([clients, tasks, executions]) => {
        statisticsData = { clients, tasks, executions };
        updateAllStatistics();
    }).catch(error => {
        console.error('Error fetching statistics:', error);
        showStatisticsError(error.message);
    });
}

function showStatisticsLoading() {
    // Update main counters
    document.getElementById('totalClientsCount').textContent = '...';
    document.getElementById('totalTasksCount').textContent = '...';
    document.getElementById('totalExecutionsCount').textContent = '...';
    document.getElementById('systemHealthScore').textContent = '...';
}

function showStatisticsError(message) {
    console.error('Statistics error:', message);
    // Could add error indicators here
}

function updateAllStatistics() {
    updateQuickStats();
    updateClientStatistics();
    updateTaskStatistics();
    updateExecutionStatistics();
    updatePluginStatistics();
    updateActivityTimeline();
    updatePerformanceTrends();
}

function updateQuickStats() {
    const { clients, tasks, executions } = statisticsData;
    
    // Total counts
    document.getElementById('totalClientsCount').textContent = clients.length;
    document.getElementById('totalTasksCount').textContent = Object.keys(tasks).length;
    document.getElementById('totalExecutionsCount').textContent = executions.length;
    
    // Calculate system health score
    const onlineClients = clients.filter(c => c.status === 'online').length;
    const clientHealthScore = clients.length > 0 ? (onlineClients / clients.length) * 100 : 0;
    
    const successfulExecs = executions.filter(e => e.exec_status === 'success').length;
    const executionHealthScore = executions.length > 0 ? (successfulExecs / executions.length) * 100 : 0;
    
    const overallHealth = Math.round((clientHealthScore + executionHealthScore) / 2);
    document.getElementById('systemHealthScore').textContent = overallHealth + '%';
}

function updateClientStatistics() {
    const { clients } = statisticsData;
    
    const onlineClients = clients.filter(c => c.status === 'online');
    const offlineClients = clients.filter(c => c.status !== 'online');
    const busyClients = clients.filter(c => c.status === 'busy' || c.current_task);
    const availableClients = onlineClients.filter(c => !c.current_task);
    
    // Calculate average response time
    const responseTimes = clients
        .filter(c => c.last_response_time)
        .map(c => parseFloat(c.last_response_time) || 0);
    const avgResponseTime = responseTimes.length > 0 
        ? Math.round(responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length)
        : 0;
    
    const availability = clients.length > 0 ? Math.round((onlineClients.length / clients.length) * 100) : 0;
    
    // Update display
    document.getElementById('onlineClientsCount').textContent = onlineClients.length;
    document.getElementById('offlineClientsCount').textContent = offlineClients.length;
    document.getElementById('avgResponseTime').textContent = avgResponseTime + 'ms';
    document.getElementById('busyClientsCount').textContent = busyClients.length;
    document.getElementById('availableClientsCount').textContent = availableClients.length;
    document.getElementById('clientAvailabilityRate').textContent = availability + '%';
}

function updateTaskStatistics() {
    const { tasks } = statisticsData;
    const taskList = Object.values(tasks);
    
    const activeTasks = taskList.filter(t => t.status === 'Active');
    const completedTasks = taskList.filter(t => t.status === 'Done');
    const failedTasks = taskList.filter(t => t.status === 'failed' || t.status === 'error');
    const scheduledTasks = taskList.filter(t => t.type === 'Schedule');
    const adhocTasks = taskList.filter(t => t.type === 'Adhoc');
    
    const totalCompleted = completedTasks.length + failedTasks.length;
    const successRate = totalCompleted > 0 ? Math.round((completedTasks.length / totalCompleted) * 100) : 0;
    
    // Update display
    document.getElementById('activeTasksCount').textContent = activeTasks.length;
    document.getElementById('completedTasksCount').textContent = completedTasks.length;
    document.getElementById('failedTasksCount').textContent = failedTasks.length;
    document.getElementById('scheduledTasksCount').textContent = scheduledTasks.length;
    document.getElementById('adhocTasksCount').textContent = adhocTasks.length;
    document.getElementById('taskSuccessRate').textContent = successRate + '%';
}

function updateExecutionStatistics() {
    const { executions } = statisticsData;
    
    const successful = executions.filter(e => e.exec_status === 'success');
    const failed = executions.filter(e => e.exec_status === 'failed');
    const errors = executions.filter(e => e.exec_status === 'error');
    
    // Time-based filtering
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const thisWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    const todayExecs = executions.filter(e => {
        const execDate = new Date(parseFloat(e.updated_at) * 1000);
        return execDate >= today;
    });
    
    const weekExecs = executions.filter(e => {
        const execDate = new Date(parseFloat(e.updated_at) * 1000);
        return execDate >= thisWeek;
    });
    
    const successRate = executions.length > 0 ? Math.round((successful.length / executions.length) * 100) : 0;
    
    // Update display
    document.getElementById('successfulExecutionsCount').textContent = successful.length;
    document.getElementById('failedExecutionsCount').textContent = failed.length;
    document.getElementById('errorExecutionsCount').textContent = errors.length;
    document.getElementById('todayExecutionsCount').textContent = todayExecs.length;
    document.getElementById('weekExecutionsCount').textContent = weekExecs.length;
    document.getElementById('executionSuccessRate').textContent = successRate + '%';
}

function updatePluginStatistics() {
    const { tasks, executions } = statisticsData;
    const taskList = Object.values(tasks);
    
    // Group by plugin
    const pluginStats = {};
    
    taskList.forEach(task => {
        const plugin = task.plugin || 'unknown';
        if (!pluginStats[plugin]) {
            pluginStats[plugin] = { tasks: 0, executions: 0, successful: 0 };
        }
        pluginStats[plugin].tasks++;
    });
    
    executions.forEach(exec => {
        // Find corresponding task to get plugin
        const task = taskList.find(t => t.id === exec.task_id);
        const plugin = task?.plugin || 'unknown';
        
        if (!pluginStats[plugin]) {
            pluginStats[plugin] = { tasks: 0, executions: 0, successful: 0 };
        }
        pluginStats[plugin].executions++;
        if (exec.exec_status === 'success') {
            pluginStats[plugin].successful++;
        }
    });
    
    // Sort by task count and take top 5
    const topPlugins = Object.entries(pluginStats)
        .sort((a, b) => b[1].tasks - a[1].tasks)
        .slice(0, 5);
    
    const tbody = document.getElementById('pluginStatsTable');
    tbody.innerHTML = '';
    
    if (topPlugins.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-3">
                    <i class="bi bi-inbox"></i> No plugin data available
                </td>
            </tr>
        `;
        return;
    }
    
    topPlugins.forEach(([plugin, stats]) => {
        const successRate = stats.executions > 0 ? Math.round((stats.successful / stats.executions) * 100) : 0;
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <i class="bi bi-plugin text-primary me-1"></i>
                <strong>${plugin}</strong>
            </td>
            <td class="text-center">${stats.tasks}</td>
            <td class="text-center">${stats.executions}</td>
            <td class="text-end">
                <span class="badge ${successRate >= 90 ? 'bg-success' : successRate >= 70 ? 'bg-warning' : 'bg-danger'}">
                    ${successRate}%
                </span>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateActivityTimeline() {
    const { executions } = statisticsData;
    
    // Group executions by hour for the last 24 hours
    const now = new Date();
    const last24h = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    const recentExecs = executions.filter(e => {
        const execDate = new Date(parseFloat(e.updated_at) * 1000);
        return execDate >= last24h;
    });
    
    // Group by hour
    const hourlyActivity = {};
    for (let i = 0; i < 24; i++) {
        const hour = new Date(now.getTime() - i * 60 * 60 * 1000);
        const hourKey = hour.toISOString().slice(0, 13); // YYYY-MM-DDTHH
        hourlyActivity[hourKey] = { total: 0, successful: 0, failed: 0 };
    }
    
    recentExecs.forEach(exec => {
        const execDate = new Date(parseFloat(exec.updated_at) * 1000);
        const hourKey = execDate.toISOString().slice(0, 13);
        
        if (hourlyActivity[hourKey]) {
            hourlyActivity[hourKey].total++;
            if (exec.exec_status === 'success') {
                hourlyActivity[hourKey].successful++;
            } else {
                hourlyActivity[hourKey].failed++;
            }
        }
    });
    
    // Show top 5 most active hours
    const topHours = Object.entries(hourlyActivity)
        .filter(([_, stats]) => stats.total > 0)
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, 5);
    
    const tbody = document.getElementById('activityTimelineTable');
    tbody.innerHTML = '';
    
    if (topHours.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" class="text-center text-muted py-3">
                    <i class="bi bi-calendar-x"></i> No activity in the last 24 hours
                </td>
            </tr>
        `;
        return;
    }
    
    topHours.forEach(([hourKey, stats]) => {
        const date = new Date(hourKey + ':00:00Z');
        const timeStr = date.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <small class="text-muted">${timeStr}</small>
            </td>
            <td>
                <span class="badge bg-primary me-1">${stats.successful}</span>
                <span class="badge bg-danger">${stats.failed}</span>
            </td>
            <td class="text-end">
                <strong>${stats.total}</strong>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updatePerformanceTrends() {
    const { tasks, executions } = statisticsData;
    
    // Calculate 7-day averages
    const now = new Date();
    const last7Days = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    const recentTasks = Object.values(tasks).filter(t => {
        if (!t.updated_at) return false;
        const taskDate = new Date(parseFloat(t.updated_at) * 1000);
        return taskDate >= last7Days;
    });
    
    const recentExecs = executions.filter(e => {
        const execDate = new Date(parseFloat(e.updated_at) * 1000);
        return execDate >= last7Days;
    });
    
    const avgTasksPerDay = Math.round(recentTasks.length / 7);
    const avgExecutionsPerDay = Math.round(recentExecs.length / 7);
    
    // Mock values for now (would need more detailed tracking)
    const avgResponseTime = 250; // ms
    const systemUptime = 99.2; // %
    
    document.getElementById('avgTasksPerDay').textContent = avgTasksPerDay;
    document.getElementById('avgExecutionsPerDay').textContent = avgExecutionsPerDay;
    document.getElementById('avgResponseTime7d').textContent = avgResponseTime + 'ms';
    document.getElementById('systemUptime').textContent = systemUptime + '%';
}

function exportStatistics() {
    const { clients, tasks, executions } = statisticsData;
    
    const exportData = {
        timestamp: new Date().toISOString(),
        summary: {
            totalClients: clients.length,
            totalTasks: Object.keys(tasks).length,
            totalExecutions: executions.length,
            onlineClients: clients.filter(c => c.status === 'online').length,
            activeTasks: Object.values(tasks).filter(t => t.status === 'Active').length,
            successfulExecutions: executions.filter(e => e.exec_status === 'success').length
        },
        details: {
            clients: clients.map(c => ({
                name: c.name,
                status: c.status,
                lastSeen: c.last_seen
            })),
            tasksByPlugin: Object.values(tasks).reduce((acc, task) => {
                const plugin = task.plugin || 'unknown';
                acc[plugin] = (acc[plugin] || 0) + 1;
                return acc;
            }, {}),
            executionsByStatus: executions.reduce((acc, exec) => {
                const status = exec.exec_status || 'unknown';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {})
        }
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `octopus-statistics-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('Statistics exported successfully!', 'success');
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Only initialize if we're on a page that includes this component
    if (document.getElementById('totalClientsCount')) {
        initializeStatistics();
    }
});

// Cleanup when page unloads
window.addEventListener('beforeunload', function() {
    if (statisticsRefreshInterval) {
        clearInterval(statisticsRefreshInterval);
    }
});
</script>
