<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ tasks|length }}</div>
        <div class="stat-label">Total Tasks</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ tasks.values()|selectattr('status', 'equalto', 'Active')|list|length }}</div>
        <div class="stat-label">Active Tasks</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ tasks.values()|selectattr('status', 'equalto', 'Done')|list|length }}</div>
        <div class="stat-label">Completed</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ tasks.values()|selectattr('status', 'in', ['failed', 'error', 'Failed'])|list|length }}</div>
        <div class="stat-label">Failed</div>
    </div>
</div>

<div class="octopus-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="octopus-section-title mb-0">
            <i class="bi bi-list-task"></i>
            Task Management
        </h3>
        <button type="button" class="btn btn-success octopus-btn" data-bs-toggle="modal" data-bs-target="#createTaskModal">
            <i class="bi bi-plus-circle"></i>
            Create New Task
        </button>
    </div>

    <!-- Tasks Table -->
    <div class="table-responsive">
        <!-- Enhanced Filter Controls -->
        <div class="card mb-3 shadow-sm">
            <div class="card-body p-3">
                <!-- Quick Search and Primary Filters (Always Visible) -->
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-bold text-primary">
                            <i class="bi bi-search"></i> Quick Search
                        </label>
                        <input type="text" class="form-control" id="taskQuickSearch" 
                               placeholder="Search tasks by ID, owner, plugin, or action..." 
                               onkeyup="applyTaskFilters()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold text-primary">Status</label>
                        <select class="form-select" id="filterTaskStatus" onchange="applyTaskFilters()">
                            <option value="">All Status</option>
                            <option value="Active" selected>üü¢ Active</option>
                            <option value="Created">üîµ Created</option>
                            <option value="Done">‚úÖ Done</option>
                            <option value="failed">‚ùå Failed</option>
                            <option value="error">üî¥ Error</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold text-primary">Type</label>
                        <select class="form-select" id="filterTaskType" onchange="applyTaskFilters()">
                            <option value="">All Types</option>
                            <option value="Adhoc">‚ö° Adhoc</option>
                            <option value="Schedule">üîÑ Schedule</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold text-primary">Time Range</label>
                        <select class="form-select" id="filterTaskTimeRange" onchange="applyTaskFilters()">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week" selected>This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex gap-1">
                            <button type="button" class="btn btn-outline-secondary btn-sm" 
                                    onclick="clearTaskFilters()" title="Clear all filters">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                    onclick="toggleAdvancedTaskFilters()" id="advancedToggle">
                                <i class="bi bi-sliders"></i> More
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Advanced Filters (Collapsible) -->
                <div class="row g-3 mt-2" id="advancedTaskFilters" style="display: none;">
                    <div class="col-12"><hr class="my-2"></div>
                    <div class="col-md-3">
                        <label class="form-label">Owner</label>
                        <input type="text" class="form-control form-control-sm" id="filterTaskOwner" 
                               placeholder="Filter by owner..." onkeyup="applyTaskFilters()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Plugin</label>
                        <input type="text" class="form-control form-control-sm" id="filterTaskPlugin" 
                               placeholder="Filter by plugin..." onkeyup="applyTaskFilters()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Action</label>
                        <input type="text" class="form-control form-control-sm" id="filterTaskAction" 
                               placeholder="Filter by action..." onkeyup="applyTaskFilters()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Executor</label>
                        <input type="text" class="form-control form-control-sm" id="filterTaskExecutor" 
                               placeholder="Filter by executor..." onkeyup="applyTaskFilters()">
                    </div>
                </div>

                <!-- Active Filters Display -->
                <div class="mt-3" id="activeTaskFilters" style="display: none;">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <small class="text-muted fw-bold">Active Filters:</small>
                        <div id="taskFilterTags"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <table class="table octopus-table table-hover align-middle" id="tasksTable">
            <thead>
                <tr>
                    <th class="sortable" onclick="sortTasksTable('id')">
                        <i class="bi bi-hash"></i> ID 
                        <i class="bi bi-chevron-expand sort-icon" id="sort-id"></i>
                    </th>
                    <th class="sortable" onclick="sortTasksTable('type')">
                        <i class="bi bi-tag"></i> Type 
                        <i class="bi bi-chevron-expand sort-icon" id="sort-type"></i>
                    </th>
                    <th class="sortable" onclick="sortTasksTable('owner')">
                        <i class="bi bi-person"></i> Owner 
                        <i class="bi bi-chevron-expand sort-icon" id="sort-owner"></i>
                    </th>
                    <th class="sortable" onclick="sortTasksTable('plugin')">
                        <i class="bi bi-plugin"></i> Plugin 
                        <i class="bi bi-chevron-expand sort-icon" id="sort-plugin"></i>
                    </th>
                    <th class="sortable" onclick="sortTasksTable('action')">
                        <i class="bi bi-play"></i> Action 
                        <i class="bi bi-chevron-expand sort-icon" id="sort-action"></i>
                    </th>
                    <th class="sortable" onclick="sortTasksTable('status')">
                        <i class="bi bi-info-circle"></i> Status 
                        <i class="bi bi-chevron-expand sort-icon" id="sort-status"></i>
                    </th>
                    <th class="sortable" onclick="sortTasksTable('executor')">
                        <i class="bi bi-cpu"></i> Executor 
                        <i class="bi bi-chevron-expand sort-icon" id="sort-executor"></i>
                    </th>
                    <th class="sortable" onclick="sortTasksTable('updated_at')">
                        <i class="bi bi-calendar3"></i> Updated 
                        <i class="bi bi-chevron-expand sort-icon" id="sort-updated_at"></i>
                    </th>
                    <th><i class="bi bi-gear"></i> Actions</th>
                </tr>
            </thead>
            <tbody id="tasksTableBody">
            <!-- Content will be populated by JavaScript filtering -->
            </tbody>
        </table>
    </div>
</div>

<script>
// Store all tasks data for filtering
let allTasks = {{ tasks|tojson }};
let tasksSortOrder = {}; // Track sort order for each column
let currentTasksSortColumn = null;

// Initialize filters on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSavedTaskFilters(); // Load saved filter preferences
    applyTaskFilters(); // Apply filters (with saved or default values)
});

function loadSavedTaskFilters() {
    // Load saved filter values from localStorage
    const savedFilters = {
        type: localStorage.getItem('taskFilter_type') || '',
        owner: localStorage.getItem('taskFilter_owner') || '',
        plugin: localStorage.getItem('taskFilter_plugin') || '',
        action: localStorage.getItem('taskFilter_action') || '',
        status: localStorage.getItem('taskFilter_status') || 'Active', // Default to Active
        executor: localStorage.getItem('taskFilter_executor') || ''
    };
    
    // Apply saved values to filter controls
    document.getElementById('filterTaskType').value = savedFilters.type;
    document.getElementById('filterTaskOwner').value = savedFilters.owner;
    document.getElementById('filterTaskPlugin').value = savedFilters.plugin;
    document.getElementById('filterTaskAction').value = savedFilters.action;
    document.getElementById('filterTaskStatus').value = savedFilters.status;
    document.getElementById('filterTaskExecutor').value = savedFilters.executor;
    
    // Update filter status indicator
    updateTaskFilterStatus();
    
    // Show/hide filter controls based on saved preference
    const filterControlsVisible = localStorage.getItem('taskFilters_visible') === 'true';
    const controls = document.getElementById('taskFilterControls');
    const toggle = document.getElementById('taskFilterToggle');
    
    if (filterControlsVisible) {
        controls.style.display = 'block';
        toggle.className = 'bi bi-chevron-up';
    } else {
        controls.style.display = 'none';
        toggle.className = 'bi bi-chevron-down';
    }
}

function saveTaskFilters() {
    // Save current filter values to localStorage
    localStorage.setItem('taskFilter_type', document.getElementById('filterTaskType').value);
    localStorage.setItem('taskFilter_owner', document.getElementById('filterTaskOwner').value);
    localStorage.setItem('taskFilter_plugin', document.getElementById('filterTaskPlugin').value);
    localStorage.setItem('taskFilter_action', document.getElementById('filterTaskAction').value);
    localStorage.setItem('taskFilter_status', document.getElementById('filterTaskStatus').value);
    localStorage.setItem('taskFilter_executor', document.getElementById('filterTaskExecutor').value);
}

function toggleTaskFilters() {
    const controls = document.getElementById('taskFilterControls');
    const toggle = document.getElementById('taskFilterToggle');
    
    if (controls.style.display === 'none') {
        controls.style.display = 'block';
        toggle.className = 'bi bi-chevron-up';
        localStorage.setItem('taskFilters_visible', 'true');
    } else {
        controls.style.display = 'none';
        toggle.className = 'bi bi-chevron-down';
        localStorage.setItem('taskFilters_visible', 'false');
    }
}

function clearTaskFilters() {
    // Clear all filter inputs including the new ones
    if(document.getElementById('taskQuickSearch')) document.getElementById('taskQuickSearch').value = '';
    if(document.getElementById('filterTaskStatus')) document.getElementById('filterTaskStatus').value = '';
    if(document.getElementById('filterTaskType')) document.getElementById('filterTaskType').value = '';
    if(document.getElementById('filterTaskTimeRange')) document.getElementById('filterTaskTimeRange').value = '';
    if(document.getElementById('filterTaskOwner')) document.getElementById('filterTaskOwner').value = '';
    if(document.getElementById('filterTaskPlugin')) document.getElementById('filterTaskPlugin').value = '';
    if(document.getElementById('filterTaskAction')) document.getElementById('filterTaskAction').value = '';
    if(document.getElementById('filterTaskExecutor')) document.getElementById('filterTaskExecutor').value = '';
    
    updateActiveTaskFilters();
    applyTaskFilters();
}

function resetTaskFiltersToDefault() {
    document.getElementById('filterTaskType').value = '';
    document.getElementById('filterTaskOwner').value = '';
    document.getElementById('filterTaskPlugin').value = '';
    document.getElementById('filterTaskAction').value = '';
    document.getElementById('filterTaskStatus').value = 'Active'; // Default to Active
    document.getElementById('filterTaskExecutor').value = '';
    saveTaskFilters(); // Save default filters
    updateTaskFilterStatus();
    applyTaskFilters();
}

function updateTaskFilterStatus() {
    const statusElement = document.getElementById('taskFilterStatus');
    const hasActiveFilters = 
        document.getElementById('filterTaskType').value ||
        document.getElementById('filterTaskOwner').value ||
        document.getElementById('filterTaskPlugin').value ||
        document.getElementById('filterTaskAction').value ||
        document.getElementById('filterTaskStatus').value ||
        document.getElementById('filterTaskExecutor').value;
    
    if (hasActiveFilters) {
        statusElement.textContent = '(saved filters applied)';
        statusElement.className = 'text-success ms-2';
    } else {
        statusElement.textContent = '(no filters)';
        statusElement.className = 'text-muted ms-2';
    }
}

function applyTaskFilters() {
    // Get all filter values
    const quickSearch = document.getElementById('taskQuickSearch') ? document.getElementById('taskQuickSearch').value.toLowerCase() : '';
    const statusFilter = document.getElementById('filterTaskStatus') ? document.getElementById('filterTaskStatus').value.toLowerCase() : '';
    const typeFilter = document.getElementById('filterTaskType') ? document.getElementById('filterTaskType').value.toLowerCase() : '';
    const timeRange = document.getElementById('filterTaskTimeRange') ? document.getElementById('filterTaskTimeRange').value : '';
    const ownerFilter = document.getElementById('filterTaskOwner') ? document.getElementById('filterTaskOwner').value.toLowerCase() : '';
    const pluginFilter = document.getElementById('filterTaskPlugin') ? document.getElementById('filterTaskPlugin').value.toLowerCase() : '';
    const actionFilter = document.getElementById('filterTaskAction') ? document.getElementById('filterTaskAction').value.toLowerCase() : '';
    const executorFilter = document.getElementById('filterTaskExecutor') ? document.getElementById('filterTaskExecutor').value.toLowerCase() : '';
    
    updateActiveTaskFilters();
    
    const tbody = document.getElementById('tasksTableBody');
    tbody.innerHTML = '';
    
    let visibleCount = 0;
    const now = new Date();
    
    // Filter tasks
    const filteredTasks = {};
    Object.entries(allTasks).forEach(([tid, task]) => {
        // Quick search across multiple fields
        if (quickSearch) {
            const searchableText = `${tid} ${task.owner} ${task.plugin} ${task.action} ${task.status} ${task.executor || ''}`.toLowerCase();
            if (!searchableText.includes(quickSearch)) return;
        }
        
        // Specific filters
        if (statusFilter && !task.status?.toLowerCase().includes(statusFilter)) return;
        if (typeFilter && !task.type?.toLowerCase().includes(typeFilter)) return;
        if (ownerFilter && !task.owner?.toLowerCase().includes(ownerFilter)) return;
        if (pluginFilter && !task.plugin?.toLowerCase().includes(pluginFilter)) return;
        if (actionFilter && !task.action?.toLowerCase().includes(actionFilter)) return;
        if (executorFilter && task.executor && !task.executor.toLowerCase().includes(executorFilter)) return;
        
        // Time range filter
        if (timeRange && task.updated_at) {
            const taskDate = new Date(parseFloat(task.updated_at) * 1000);
            const daysDiff = (now - taskDate) / (1000 * 60 * 60 * 24);
            
            switch(timeRange) {
                case 'today':
                    if (daysDiff > 1) return;
                    break;
                case 'week':
                    if (daysDiff > 7) return;
                    break;
                case 'month':
                    if (daysDiff > 30) return;
                    break;
            }
        }
        
        filteredTasks[tid] = task;
    });
    
    // Sort filtered tasks if needed
    let sortedTasks;
    if (currentTasksSortColumn && tasksSortOrder[currentTasksSortColumn]) {
        sortedTasks = sortTasksData(filteredTasks, currentTasksSortColumn, tasksSortOrder[currentTasksSortColumn]);
    } else {
        sortedTasks = Object.entries(filteredTasks);
    }
    
    sortedTasks.forEach(([tid, task]) => {
        
        visibleCount++;
        
        // Create table row
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="task-id-cell">
                <code class="text-muted id-tooltip" onclick="copyToClipboard('${tid}')" title="${tid}">${tid}</code>
            </td>
            <td>
                <span class="badge bg-info">
                    <i class="bi bi-${task.type === 'Adhoc' ? 'lightning' : 'calendar-event'}"></i>
                    ${task.type || 'Adhoc'}
                </span>
            </td>
            <td>
                <span class="badge bg-primary">
                    <i class="bi bi-person"></i> ${task.owner}
                </span>
            </td>
            <td>
                <span class="badge bg-secondary">
                    <i class="bi bi-plugin"></i> ${task.plugin}
                </span>
            </td>
            <td><code>${task.action}</code></td>
            <td>${getStatusBadge(task.status)}</td>
            <td>
                ${task.executor ? 
                    `<span class="badge bg-primary"><i class="bi bi-person-check"></i> ${task.executor}</span>` : 
                    '<span class="text-muted">Unassigned</span>'
                }
            </td>
            <td>
                <small class="text-muted">${formatTimestamp(task.updated_at)}</small>
            </td>
            <td>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-info octopus-btn" 
                            title="View Details" 
                            data-bs-toggle="modal" 
                            data-bs-target="#taskDetailsModal"
                            onclick="viewTaskDetails(this)"
                            data-task-id="${escapeHtml(tid)}"
                            data-task-type="${escapeHtml(task.type || 'Adhoc')}"
                            data-task-owner="${escapeHtml(task.owner)}"
                            data-task-plugin="${escapeHtml(task.plugin)}"
                            data-task-action="${escapeHtml(task.action)}"
                            data-task-status="${escapeHtml(task.status)}"
                            data-task-executor="${escapeHtml(task.executor || '')}"
                            data-task-updated="${escapeHtml(task.updated_at)}"
                            data-task-args="${escapeHtml(task.args || '[]')}"
                            data-task-kwargs="${escapeHtml(task.kwargs || '{}')}"
                            data-task-start="${escapeHtml(task.execution_start_time || '')}"
                            data-task-end="${escapeHtml(task.execution_end_time || '')}"
                            data-task-interval="${escapeHtml(task.interval || '')}">
                        <i class="bi bi-eye"></i>
                    </button>
                    ${task.status !== 'Created' ? `
                        <button type="button" class="btn btn-sm btn-primary octopus-btn" 
                                title="Edit Task"
                                onclick="editTaskDetails(this)"
                                data-task-id="${escapeHtml(tid)}"
                                data-task-type="${escapeHtml(task.type || 'Adhoc')}"
                                data-task-owner="${escapeHtml(task.owner)}"
                                data-task-plugin="${escapeHtml(task.plugin)}"
                                data-task-action="${escapeHtml(task.action)}"
                                data-task-args="${escapeHtml(task.args || '[]')}"
                                data-task-kwargs="${escapeHtml(task.kwargs || '{}')}"
                                data-task-start="${escapeHtml(task.execution_start_time || '')}"
                                data-task-end="${escapeHtml(task.execution_end_time || '')}"
                                data-task-interval="${escapeHtml(task.interval || '')}">
                            <i class="bi bi-pencil"></i>
                        </button>
                    ` : ''}
                    <button class="btn btn-sm btn-danger octopus-btn" 
                            title="Delete Task"
                            onclick="deleteTaskFromFilter('${tid}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Show message if no results
    if (visibleCount === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="9" class="text-center text-muted py-4">
                <i class="bi bi-search display-4"></i>
                <div class="mt-2">No tasks match the current filters</div>
                <small>Try adjusting your filter criteria</small>
            </td>
        `;
        tbody.appendChild(row);
    }
}

function getStatusBadge(status) {
    if (status === 'Active') {
        return '<span class="badge bg-info"><i class="bi bi-play-fill"></i> Active</span>';
    } else if (status === 'Done') {
        return '<span class="badge bg-success"><i class="bi bi-check-lg"></i> Done</span>';
    } else if (status === 'Created') {
        return '<span class="badge bg-secondary"><i class="bi bi-clock"></i> Created</span>';
    } else if (['failed', 'error', 'Failed'].includes(status)) {
        return '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> ' + status + '</span>';
    } else {
        return '<span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i> ' + status + '</span>';
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function deleteTaskFromFilter(taskId) {
    if (confirm('Are you sure you want to delete this task?')) {
        window.location.href = `/tasks-ui/delete/${taskId}?tab=tasks`;
    }
}

function sortTasksTable(column) {
    // Toggle sort order
    if (currentTasksSortColumn === column) {
        tasksSortOrder[column] = tasksSortOrder[column] === 'asc' ? 'desc' : 'asc';
    } else {
        tasksSortOrder[column] = 'asc';
        currentTasksSortColumn = column;
    }
    
    // Update sort icons
    updateTasksSortIcons(column);
    
    // Sort and re-render table
    applyTaskFilters();
}

function updateTasksSortIcons(activeColumn) {
    // Reset all sort icons
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.className = 'bi bi-chevron-expand sort-icon';
    });
    
    // Set active column icon
    const activeIcon = document.getElementById(`sort-${activeColumn}`);
    if (activeIcon) {
        const order = tasksSortOrder[activeColumn];
        activeIcon.className = `bi bi-chevron-${order === 'asc' ? 'up' : 'down'} sort-icon`;
    }
}

function sortTasksData(tasks, column, order) {
    return Object.entries(tasks).sort(([tidA, taskA], [tidB, taskB]) => {
        let valueA, valueB;
        
        switch (column) {
            case 'id':
                valueA = tidA;
                valueB = tidB;
                break;
            case 'type':
                valueA = taskA.type || 'Adhoc';
                valueB = taskB.type || 'Adhoc';
                break;
            case 'owner':
                valueA = taskA.owner || '';
                valueB = taskB.owner || '';
                break;
            case 'plugin':
                valueA = taskA.plugin || '';
                valueB = taskB.plugin || '';
                break;
            case 'action':
                valueA = taskA.action || '';
                valueB = taskB.action || '';
                break;
            case 'status':
                valueA = taskA.status || '';
                valueB = taskB.status || '';
                break;
            case 'executor':
                valueA = taskA.executor || '';
                valueB = taskB.executor || '';
                break;
            case 'updated_at':
                valueA = parseFloat(taskA.updated_at || taskA.created_at || 0);
                valueB = parseFloat(taskB.updated_at || taskB.created_at || 0);
                break;
            default:
                return 0;
        }
        
        // Handle numeric vs string comparison
        if (column === 'updated_at') {
            return order === 'asc' ? valueA - valueB : valueB - valueA;
        } else {
            const result = String(valueA).localeCompare(String(valueB));
            return order === 'asc' ? result : -result;
        }
    });
}

// Enhanced filtering functions for improved UX
function toggleAdvancedTaskFilters() {
    const advancedFilters = document.getElementById('advancedTaskFilters');
    const toggleBtn = document.getElementById('advancedToggle');
    
    if (advancedFilters.style.display === 'none') {
        advancedFilters.style.display = 'block';
        toggleBtn.innerHTML = '<i class="bi bi-sliders"></i> Less';
    } else {
        advancedFilters.style.display = 'none';
        toggleBtn.innerHTML = '<i class="bi bi-sliders"></i> More';
    }
}

function updateActiveTaskFilters() {
    const activeFiltersDiv = document.getElementById('activeTaskFilters');
    const tagsContainer = document.getElementById('taskFilterTags');
    const filters = [];
    
    // Check all filter inputs for values
    const quickSearch = document.getElementById('taskQuickSearch').value;
    const status = document.getElementById('filterTaskStatus').value;
    const type = document.getElementById('filterTaskType').value;
    const timeRange = document.getElementById('filterTaskTimeRange').value;
    const owner = document.getElementById('filterTaskOwner').value;
    const plugin = document.getElementById('filterTaskPlugin').value;
    const action = document.getElementById('filterTaskAction').value;
    const executor = document.getElementById('filterTaskExecutor').value;
    
    if (quickSearch) filters.push({label: `Search: "${quickSearch}"`, type: 'search'});
    if (status) filters.push({label: `Status: ${status}`, type: 'status'});
    if (type) filters.push({label: `Type: ${type}`, type: 'type'});
    if (timeRange) filters.push({label: `Time: ${timeRange}`, type: 'time'});
    if (owner) filters.push({label: `Owner: "${owner}"`, type: 'owner'});
    if (plugin) filters.push({label: `Plugin: "${plugin}"`, type: 'plugin'});
    if (action) filters.push({label: `Action: "${action}"`, type: 'action'});
    if (executor) filters.push({label: `Executor: "${executor}"`, type: 'executor'});
    
    if (filters.length > 0) {
        activeFiltersDiv.style.display = 'block';
        tagsContainer.innerHTML = filters.map(filter => 
            `<span class="badge bg-light text-dark border me-1 mb-1">
                ${filter.label}
                <button type="button" class="btn-close btn-close-sm ms-1" 
                        onclick="removeTaskFilter('${filter.type}')" style="font-size: 0.7em;"></button>
            </span>`
        ).join('');
    } else {
        activeFiltersDiv.style.display = 'none';
    }
}

function removeTaskFilter(filterType) {
    switch(filterType) {
        case 'search': document.getElementById('taskQuickSearch').value = ''; break;
        case 'status': document.getElementById('filterTaskStatus').value = ''; break;
        case 'type': document.getElementById('filterTaskType').value = ''; break;
        case 'time': document.getElementById('filterTaskTimeRange').value = ''; break;
        case 'owner': document.getElementById('filterTaskOwner').value = ''; break;
        case 'plugin': document.getElementById('filterTaskPlugin').value = ''; break;
        case 'action': document.getElementById('filterTaskAction').value = ''; break;
        case 'executor': document.getElementById('filterTaskExecutor').value = ''; break;
    }
    updateActiveTaskFilters();
    applyTaskFilters();
}
</script>
